<!DOCTYPE html>
<html>
<head>
    <title>数据库设置</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>星耀AI 数据库设置</h1>
    <button onclick="setupDatabase()">设置数据库</button>
    <div id="result"></div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://zopkskdrfgspslrjyini.supabase.co';
        const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvcGtza2RyZmdzcHNscmp5aW5pIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzE4ODI1NiwiZXhwIjoyMDc4NzY0MjU2fQ.06s9KFbsxy7g1gjblBAjvQ7R1nscEPH5JIQ3seUSXxQ';
        
        const supabaseClient = createClient(supabaseUrl, supabaseServiceKey);

        async function setupDatabase() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '正在设置数据库...';
            
            try {
                // 1. 创建用户表
                const createUsersTable = await fetch('/api/setup/tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sql: `
                            CREATE TABLE IF NOT EXISTS users (
                                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                                username VARCHAR(255) UNIQUE NOT NULL,
                                password TEXT NOT NULL,
                                created_at TIMESTAMP DEFAULT NOW()
                            );
                        `
                    })
                });

                resultDiv.innerHTML += '<br>创建用户表: ' + (createUsersTable.ok ? '成功' : '失败');

                // 2. 创建助手表
                const createAssistantsTable = await fetch('/api/setup/tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sql: `
                            CREATE TABLE IF NOT EXISTS assistants (
                                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                                name VARCHAR(255) NOT NULL,
                                description TEXT,
                                dify_api_key TEXT NOT NULL,
                                dify_app_id VARCHAR(255) NOT NULL,
                                dify_base_url TEXT DEFAULT 'https://api.dify.ai/v1',
                                status VARCHAR(50) DEFAULT 'active',
                                icon_name VARCHAR(100),
                                created_at TIMESTAMP DEFAULT NOW(),
                                updated_at TIMESTAMP DEFAULT NOW()
                            );
                        `
                    })
                });

                resultDiv.innerHTML += '<br>创建助手表: ' + (createAssistantsTable.ok ? '成功' : '失败');

                // 3. 插入默认用户
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .insert([{ username: 'admin', password: 'password' }])
                    .select();

                if (userError) {
                    resultDiv.innerHTML += '<br>插入用户: 失败 - ' + userError.message;
                } else {
                    resultDiv.innerHTML += '<br>插入用户: 成功';
                }

                // 4. 插入助手配置
                const { data: assistantData, error: assistantError } = await supabaseClient
                    .from('assistants')
                    .insert([
                        {
                            name: 'IP策划师',
                            description: '帮你构建个人IP形象和人设定位，专注于品牌定位、人设包装',
                            dify_api_key: 'YOUR_DIFY_API_KEY',
                            dify_app_id: 'app-CC6sKsQ0DG30G6OqjnABxjJF',
                            icon_name: 'brain'
                        },
                        {
                            name: '短视频脚本专家',
                            description: '专业短视频脚本创作和优化，擅长脚本创作、内容规划',
                            dify_api_key: 'YOUR_DIFY_API_KEY',
                            dify_app_id: 'app-CC6sKsQ0DG30G6OqjnABxjJF',
                            icon_name: 'video'
                        },
                        {
                            name: '获客策略顾问',
                            description: '制定精准获客方案和执行策略，专注于客户获取、转化优化',
                            dify_api_key: 'YOUR_DIFY_API_KEY',
                            dify_app_id: 'app-CC6sKsQ0DG30G6OqjnABxjJF',
                            icon_name: 'target'
                        },
                        {
                            name: '内容策划师',
                            description: '内容主题策划和创意方案，擅长内容营销、话题策划',
                            dify_api_key: 'YOUR_DIFY_API_KEY',
                            dify_app_id: 'app-CC6sKsQ0DG30G6OqjnABxjJF',
                            icon_name: 'file-text'
                        },
                        {
                            name: '视频制作助手',
                            description: '视频拍摄指导和后期建议，专注于制作流程、技术指导',
                            dify_api_key: 'YOUR_DIFY_API_KEY',
                            dify_app_id: 'app-CC6sKsQ0DG30G6OqjnABxjJF',
                            icon_name: 'film'
                        }
                    ])
                    .select();

                if (assistantError) {
                    resultDiv.innerHTML += '<br>插入助手: 失败 - ' + assistantError.message;
                } else {
                    resultDiv.innerHTML += '<br>插入助手: 成功 - ' + assistantData.length + ' 个助手';
                }

                resultDiv.innerHTML += '<br><br>数据库设置完成！';

            } catch (error) {
                resultDiv.innerHTML += '<br>错误: ' + error.message;
            }
        }
    </script>
</body>
</html>